#include "matrix.h"

void apply_mm(matrix m1, matrix m2, matrix mm)
{
  mm[0][0] = 
    m1[0][0] *  m2[0][0] +
    m1[0][1] *  m2[1][0] +
    m1[0][2] *  m2[2][0] +
    m1[0][3] *  m2[3][0];

  mm[1][0] =
    m1[1][0] *  m2[0][0] +
    m1[1][1] *  m2[1][0] +
    m1[1][2] *  m2[2][0] +
    m1[1][3] *  m2[3][0];

 mm[2][0] =
    m1[2][0] *  m2[0][0] +
    m1[2][1] *  m2[1][0] +
    m1[2][2] *  m2[2][0] +
    m1[2][3] *  m2[3][0];

 mm[3][0] =
    m1[3][0] *  m2[0][0] +
    m1[3][1] *  m2[1][0] +
    m1[3][2] *  m2[2][0] +
    m1[3][3] *  m2[3][0];


  mm[0][1] =
    m1[0][0] *  m2[0][1] +
    m1[0][1] *  m2[1][1] +
    m1[0][2] *  m2[2][1] +
    m1[0][3] *  m2[3][1];

  mm[1][1] =
    m1[1][0] *  m2[0][1] +
    m1[1][1] *  m2[1][1] +
    m1[1][2] *  m2[2][1] +
    m1[1][3] *  m2[3][1];

 mm[2][1] =
    m1[2][0] *  m2[0][1] +
    m1[2][1] *  m2[1][1] +
    m1[2][2] *  m2[2][1] +
    m1[2][3] *  m2[3][1];

 mm[3][1] =
    m1[3][0] *  m2[0][1] +
    m1[3][1] *  m2[1][1] +
    m1[3][2] *  m2[2][1] +
    m1[3][3] *  m2[3][1];


  mm[0][2] = 
    m1[0][0] *  m2[0][2] +
    m1[0][1] *  m2[1][2] +
    m1[0][2] *  m2[2][2] +
    m1[0][3] *  m2[3][2];

 mm[1][2] =
    m1[1][0] *  m2[0][2] +
    m1[1][1] *  m2[1][2] +
    m1[1][2] *  m2[2][2] +
    m1[1][3] *  m2[3][2];

  mm[2][2] =
    m1[2][0] *  m2[0][2] +
    m1[2][1] *  m2[1][2] +
    m1[2][2] *  m2[2][2] +
    m1[2][3] *  m2[3][2];

 mm[3][2] =
    m1[3][0] *  m2[0][2] +
    m1[3][1] *  m2[1][2] +
    m1[3][2] *  m2[2][2] +
    m1[3][3] *  m2[3][2];

 
 mm[0][3] =
   m1[0][0] *  m2[0][3] +
   m1[0][1] *  m2[1][3] +
   m1[0][2] *  m2[2][3] +
   m1[0][3] *  m2[3][3];

 mm[1][3] =
   m1[1][0] *  m2[0][3] +
   m1[1][1] *  m2[1][3] +
   m1[1][2] *  m2[2][3] +
   m1[1][3] *  m2[3][3];

 mm[2][3] =
    m1[2][0] *  m2[0][3] +
    m1[2][1] *  m2[1][3] +
    m1[2][2] *  m2[2][3] +
    m1[2][3] *  m2[3][3];
 
 mm[3][3] =
   m1[3][0] *  m2[0][3] +
   m1[3][1] *  m2[1][3] +
   m1[3][2] *  m2[2][3] +
   m1[3][3] *  m2[3][3];
}

void apply_mp(matrix m, struct v3 *p, struct v3 *mp)
{
  mp->x = 
    m[0][0] *  p->x + 
    m[1][0] *  p->y +
    m[2][0] *  p->z +
    m[3][0] *  p->w;

  mp->y = 
    m[0][1] *  p->x + 
    m[1][1] *  p->y +
    m[2][1] *  p->z +
    m[3][1] *  p->w;

  mp->z = 
    m[0][2] *  p->x + 
    m[1][2] *  p->y +
    m[2][2] *  p->z +
    m[3][2] *  p->w;


  mp->w = 
    m[0][3] *  p->x + 
    m[1][3] *  p->y +
    m[2][3] *  p->z +
    m[3][3] *  p->w;

}

void apply_w(struct v3 *p)
{
  if(p->w == 0) 
    p->x = p->y = p->z = 0.0000001;
  else {
    p->x = p->x / p->w;
    p->y = p->y / p->w;
    p->z = p->z / p->w;
  }
  p->w = 1;
}

void rot_x(float rot, matrix m)
{
  m[0][0] = 1;
  m[1][0] = 0;
  m[2][0] = 0;
  m[3][0] = 0;

  m[0][1] = 0;
  m[1][1] = cos(rot);
  m[2][1] = sin(rot);
  m[3][1] = 0;

  m[0][2] = 0;
  m[1][2] = -sin(rot);
  m[2][2] = cos(rot);
  m[3][2] = 0;

  m[0][3] = 0;
  m[1][3] = 0;
  m[2][3] = 0;
  m[3][3] = 1;
}

void rot_y(float rot, matrix m)
{
  m[0][0] = cos(rot);
  m[1][0] = 0;
  m[2][0] = -sin(rot);
  m[3][0] = 0;  

  m[0][1] = 0;
  m[1][1] = 1;
  m[2][1] = 0;
  m[3][1] = 0;

  m[0][2] = sin(rot);
  m[1][2] = 0;
  m[2][2] = cos(rot);
  m[3][2] = 0;

  m[0][3] = 0;
  m[1][3] = 0;
  m[2][3] = 0;
  m[3][3] = 1;
}

void rot_z(float rot, matrix m)
{
  m[0][0] = cos(rot);
  m[1][0] = sin(rot);
  m[2][0] = 0;
  m[3][0] = 0;  

  m[0][1] = -sin(rot);
  m[1][1] = cos(rot);
  m[2][1] = 0;
  m[3][1] = 0;

  m[0][2] = 0;
  m[1][2] = 0;
  m[2][2] = 1;
  m[3][2] = 0;

  m[0][3] = 0;
  m[1][3] = 0;
  m[2][3] = 0;
  m[3][3] = 1;
}

void id(matrix m)
{
  m[0][0] = 1;
  m[1][0] = 0;
  m[2][0] = 0;
  m[3][0] = 0;  

  m[0][1] = 0;
  m[1][1] = 1;
  m[2][1] = 0;
  m[3][1] = 0;

  m[0][2] = 0;
  m[1][2] = 0;
  m[2][2] = 1;
  m[3][2] = 0;

  m[0][3] = 0;
  m[1][3] = 0;
  m[2][3] = 0;
  m[3][3] = 1;
}

void rotate(struct v3 rot, matrix m)
{
  matrix mx, my, mz, mxy;
  
  rot_x(rot.x, mx);
  rot_y(rot.y, my);
  rot_z(rot.z, mz);

  apply_mm(mx, my, mxy);
  apply_mm(mxy, mz, m);
}

void translate(struct v3 trans, matrix m)
{
  id(m);
  m[3][0] = trans.x;
  m[3][1] = trans.y;
  m[3][2] = trans.z;
}

void scale(struct v3 scale, matrix m)
{
  id(m);
  m[0][0] = scale.x;
  m[1][1] = scale.y;
  m[2][2] = scale.z;
}

void perspective(float u, float v, matrix m)
{
  /*  memset(m, 0, sizeof(matrix));
      m[0][0] = cotfx(u);
      m[1][1] = cotfx(v);
      m[2][3] = itofx(1);
  */
  /*
    memset(m, 0, sizeof(matrix));
    m[0][0] = ftofx(2.5);
    m[1][1] = ftofx(1.875);
    m[2][2] = itofx(1);
    m[2][3] = itofx(1);
   m[3][2] = itofx(2000); 
  */
  
  id(m); 
  m[3][3] = 0.2; 
  m[2][3] = 0.008;
}

float determinant(matrix m)
{
  return 
    m[0][3]* m[1][2] *  m[2][1] *  m[3][0] - 
    m[0][2]* m[1][3] *  m[2][1] *  m[3][0] -
    m[0][3]* m[1][1] *  m[2][2] *  m[3][0] +
    m[0][1]* m[1][3] *  m[2][2] *  m[3][0] +
    m[0][2]* m[1][1] *  m[2][3] *  m[3][0] -
    m[0][1]* m[1][2] *  m[2][3] *  m[3][0] -
    m[0][3]* m[1][2] *  m[2][0] *  m[3][1] +
    m[0][2]* m[1][3] *  m[2][0] *  m[3][1] + 
    m[0][3]* m[1][0] *  m[2][2] *  m[3][1] -
    m[0][0]* m[1][3] *  m[2][2] *  m[3][1] -
    m[0][2]* m[1][0] *  m[2][3] *  m[3][1] +
    m[0][0]* m[1][2] *  m[2][3] *  m[3][1] +
    m[0][3]* m[1][1] *  m[2][0] *  m[3][2] -
    m[0][1]* m[1][3] *  m[2][0] *  m[3][2] -
    m[0][3]* m[1][0] *  m[2][1] *  m[3][2] +
    m[0][0]* m[1][3] *  m[2][1] *  m[3][2] +
    m[0][1]* m[1][0] *  m[2][3] *  m[3][2] -
    m[0][0]* m[1][1] *  m[2][3] *  m[3][2] -
    m[0][2]* m[1][1] *  m[2][0] *  m[3][3] +
    m[0][1]* m[1][2] *  m[2][0] *  m[3][3] +
    m[0][2]* m[1][0] *  m[2][1] *  m[3][3] -
    m[0][0]* m[1][2] *  m[2][1] *  m[3][3] -
    m[0][1]* m[1][0] *  m[2][2] *  m[3][3] +
    m[0][0]* m[1][1] *  m[2][2] *  m[3][3];
}

/*--------------*/
#ifdef DEBUG

void printv3(struct v3 p)
{
  printf("|%f\t%f\t%f\t%f|\n", p.x, p.y, p.z, p.w);
}

void printm(matrix m)
{
  printf("+---                                                     ---+\n");
  printf("|%f\t%f\t%f\t%f|\n", m[0][0], m[1][0], m[2][0], m[3][0]);
  printf("|%f\t%f\t%f\t%f|\n", m[0][1], m[1][1], m[2][1], m[3][1]);
  printf("|%f\t%f\t%f\t%f|\n", m[0][2], m[1][2], m[2][2], m[3][2]);
  printf("|%f\t%f\t%f\t%f|\n", m[0][3], m[1][3], m[2][3], m[3][3]);
  printf("+---                                                     ---+\n");
}

#endif
